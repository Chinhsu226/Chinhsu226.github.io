<!DOCTYPE html><html lang="zh-CN" class="light"><head><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸå¸‚äººå£åŠ¨æ€æ¡å½¢å›¾</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans SC', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&amp;display=swap" rel="stylesheet">
    <style>
        /* ç¡®ä¿å›¾è¡¨åŒºåŸŸæœ‰è¶³å¤Ÿçš„é«˜åº¦ */
        .chart-container {
            min-height: 600px;
            overflow: visible !important;
        }
        
        /* æ”¹è¿›çš„æ¡å½¢åŠ¨ç”»è¿‡æ¸¡æ•ˆæœ */
        .bar-item {
            transition: 
                opacity 0.5s cubic-bezier(0.2, 0, 0, 1), 
                transform 0.7s cubic-bezier(0.34, 1.56, 0.64, 1); /* å¼¹æ€§åŠ¨ç”»æ›²çº¿ */
            display: flex;
            align-items: center;
            height: 3.5rem;
            width: 100%;
            margin-bottom: 0.5rem; /* å¢åŠ æ¡å½¢ä¹‹é—´çš„é—´è· */
            position: absolute;
            left: 0;
            box-sizing: border-box;
            padding-left: 1rem;
            padding-right: 1rem;
        }

        .bar-item .bar {
            transition: 
                width var(--bar-transition-duration, 0.8s) cubic-bezier(0.34, 1.3, 0.64, 1), /* æ·»åŠ è½»å¾®è¿‡å†²æ•ˆæœ */
                opacity 0.3s ease,
                transform 0.3s ease,
                box-shadow 0.3s ease;
            opacity: 0.85;
            transform-origin: left center;
        }

        .bar-item:hover {
            z-index: 10; /* ç¡®ä¿æ‚¬åœæ—¶åœ¨é¡¶å±‚ */
        }

        .bar-item:hover .bar {
            opacity: 1;
            transform: scaleY(1.05); /* è½»å¾®æ”¾å¤§æ•ˆæœ */
            box-shadow: 0 0 12px rgba(59, 130, 246, 0.6);
        }
        
        .bar-item:hover .country-name {
            font-weight: 600;
            color: #2563eb;
        }
        
        /* ä¼˜åŒ–çš„æ•°å€¼æ ‡ç­¾æ ·å¼ä¸è¿‡æ¸¡ */
        .bar-item .value-label {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            transition: 
                left var(--bar-transition-duration, 0.8s) cubic-bezier(0.34, 1.3, 0.64, 1),
                color 0.3s ease,
                font-weight 0.3s ease;
            white-space: nowrap;
            padding: 0 4px;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        
        .bar-item:hover .value-label {
            font-weight: 600;
        }

        /* æ»‘å—æ ·å¼ä¼˜åŒ– */
        input[type="range"] {
            -webkit-appearance: none;
            height: 6px;
            border-radius: 5px;
            background: #e5e7eb;
            outline: none;
            transition: background 0.3s;
        }
        
        .dark input[type="range"] {
            background: #3f3f46;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            background: #2563eb;
            transform: scale(1.1);
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.5);
        }
        
        input[type="range"]::-moz-range-thumb:hover {
            background: #2563eb;
            transform: scale(1.1);
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.5);
        }

        /* ç­›é€‰æŒ‰é’®æ ·å¼ä¼˜åŒ– */
        .filter-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .filter-btn.active {
            font-weight: bold;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
        
        .filter-btn:hover:not(.active) {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* æ¡å½¢å›¾å®¹å™¨ */
        #barChart {
            position: relative;
            width: 100%;
            min-height: 600px;
            margin-bottom: 2rem; /* æ·»åŠ åº•éƒ¨é—´è· */
        }

        /* TimelineæŒ‡ç¤ºå™¨ä¼˜åŒ– */
        #timeline #currentIndicator {
            transition: left 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            animation: breathe 3s infinite;
            box-shadow: 0 0 8px #ef4444;
        }
        
        @keyframes breathe {
            0% { transform: scale(1); box-shadow: 0 0 8px rgba(239, 68, 68, 0.6); }
            50% { transform: scale(1.15); box-shadow: 0 0 15px rgba(239, 68, 68, 0.8); }
            100% { transform: scale(1); box-shadow: 0 0 8px rgba(239, 68, 68, 0.6); }
        }
        
        /* æ•°å­—æ»šåŠ¨åŠ¨ç”» */
        .number-animation {
            display: inline-block;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        
        .number-animation.changing {
            transform: translateY(-20px);
            opacity: 0;
        }
        
        /* æ§åˆ¶æŒ‰é’®æ‚¬æµ®æ•ˆæœ */
        .control-button {
            transition: all 0.3s ease;
        }
        
        .control-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 640px) {
            .bar-item {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
                height: 3rem;
            }
            
            #currentYearDisplay {
                font-size: 2rem;
            }
            
            .filter-btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }
            
            .bar-item .country-name {
                font-size: 0.875rem;
            }
            
            .bar-item .value-label {
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body class="bg-white dark:bg-zinc-900 text-gray-900 dark:text-white transition-colors duration-300">
    <!-- é¡¶éƒ¨æ§åˆ¶æ  -->
    <header class="container mx-auto px-4 py-6 md:px-6">
        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white">åŸå¸‚äººå£åŠ¨æ€æ¡å½¢å›¾</h1>
            <div class="flex flex-wrap items-center gap-3 md:gap-4">
                <button id="playPauseBtn" class="control-button bg-gray-200 dark:bg-zinc-700 px-4 py-2 rounded-md hover:bg-gray-300 dark:hover:bg-zinc-600 transition text-gray-800 dark:text-white flex items-center">
                    <span id="playIcon">â–¶ æ’­æ”¾</span>
                    <span id="pauseIcon" class="hidden">â¸ æš‚åœ</span>
                </button>
                <div class="flex items-center">
                    <span class="text-gray-700 dark:text-gray-300 mr-2">é€Ÿåº¦:</span>
                    <select id="speedControl" class="bg-gray-200 dark:bg-zinc-700 px-2 py-1 rounded-md text-gray-800 dark:text-white">
                        <option value="0.5">0.5x</option>
                        <option value="1" selected="">1x</option>
                        <option value="2">2x</option>
                        <option value="4">4x</option>
                    </select>
                </div>
                <button id="themeToggle" class="control-button bg-gray-200 dark:bg-zinc-700 px-4 py-2 rounded-md hover:bg-gray-300 dark:hover:bg-zinc-600 transition text-gray-800 dark:text-white">
                    <span id="lightIcon" class="hidden">â˜€ï¸</span>
                    <span id="darkIcon">ğŸŒ™</span>
                </button>
            </div>
        </div>
        <div class="mt-6 relative">
            <div class="flex items-center justify-between">
                <div class="flex items-baseline">
                    <span id="currentYearDisplay" class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white">1960</span>
                    <span class="ml-2 text-lg text-gray-600 dark:text-gray-400">å¹´</span>
                </div>
                <div id="totalPopulationContainer" class="flex flex-col items-end">
                    <span class="text-sm text-gray-600 dark:text-gray-400">å½“å‰å¹´ä»½åŸå¸‚æ€»äººå£</span>
                    <span id="totalPopulation" class="text-xl font-semibold text-gray-700 dark:text-gray-300">0</span>
                </div>
            </div>
            
            <input type="range" id="yearSlider" min="0" max="56" value="0" class="w-full h-2 rounded-lg appearance-none cursor-pointer mt-8">
            <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400 mt-1 w-full overflow-hidden">
                <span>1960</span>
                <span class="hidden md:inline">1970</span>
                <span>1980</span>
                <span class="hidden md:inline">1990</span>
                <span>2000</span>
                <span class="hidden md:inline">2010</span>
                <span>2016</span>
            </div>
        </div>
    </header>

    <!-- è¿‡æ»¤å™¨ -->
    <div class="container mx-auto px-4 mt-4">
        <div id="continentFilter" class="flex flex-wrap gap-2 justify-center">
            <button class="filter-btn bg-gray-200 dark:bg-zinc-700 px-3 py-1 rounded-md text-gray-800 dark:text-white text-sm hover:bg-gray-300 dark:hover:bg-zinc-600 transition active" data-continent="all">æ‰€æœ‰åœ°åŒº</button>
            <button class="filter-btn bg-blue-100 dark:bg-blue-900 px-3 py-1 rounded-md text-blue-800 dark:text-blue-200 text-sm hover:bg-blue-200 dark:hover:bg-blue-800 transition" data-continent="äºšæ´²">äºšæ´²</button>
            <button class="filter-btn bg-purple-100 dark:bg-purple-900 px-3 py-1 rounded-md text-purple-800 dark:text-purple-200 text-sm hover:bg-purple-200 dark:hover:bg-purple-800 transition" data-continent="æ¬§æ´²">æ¬§æ´²</button>
            <button class="filter-btn bg-orange-100 dark:bg-orange-900 px-3 py-1 rounded-md text-orange-800 dark:text-orange-200 text-sm hover:bg-orange-200 dark:hover:bg-orange-800 transition" data-continent="åŒ—ç¾æ´²">åŒ—ç¾æ´²</button>
            <button class="filter-btn bg-yellow-100 dark:bg-yellow-900 px-3 py-1 rounded-md text-yellow-800 dark:text-yellow-200 text-sm hover:bg-yellow-200 dark:hover:bg-yellow-800 transition" data-continent="å—ç¾æ´²">å—ç¾æ´²</button>
            <button class="filter-btn bg-green-100 dark:bg-green-900 px-3 py-1 rounded-md text-green-800 dark:text-green-200 text-sm hover:bg-green-200 dark:hover:bg-green-800 transition" data-continent="éæ´²">éæ´²</button>
            <button class="filter-btn bg-pink-100 dark:bg-pink-900 px-3 py-1 rounded-md text-pink-800 dark:text-pink-200 text-sm hover:bg-pink-200 dark:hover:bg-pink-800 transition" data-continent="å¤§æ´‹æ´²">å¤§æ´‹æ´²</button>
        </div>
    </div>

    <!-- ä¸»ä½“å›¾è¡¨åŒº -->
    <main class="container mx-auto px-4 py-6">
        <div class="chart-container">
            <!-- barChart now uses absolute positioning for children -->
            <div id="barChart" class="w-full">
                <!-- å›¾è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </main>

    <!-- åº•éƒ¨æ—¶é—´è½´ -->
    <footer class="container mx-auto px-4 py-6 mt-4">
        <div class="flex justify-center">
            <div id="timeline" class="w-full h-12 flex items-center relative">
                <!-- æ—¶é—´ç‚¹å’ŒæŒ‡ç¤ºå™¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        <div class="text-center mt-8 text-sm text-gray-600 dark:text-gray-400">
            <p>æ•°æ®èŒƒå›´: 1960-2016 | åŸå¸‚äººå£åŠ¨æ€å¯è§†åŒ–</p>
            <p class="mt-2 text-xs">ä½¿ç”¨é”®ç›˜å¿«æ·é”®: ç©ºæ ¼(æ’­æ”¾/æš‚åœ), å·¦å³ç®­å¤´(å‰åè°ƒæ•´å¹´ä»½)</p>
        </div>
    </footer>

    <script>
        // ç¤ºä¾‹æ•°æ® - åŒ…å«15ä¸ªä¸»è¦å›½å®¶çš„åŸå¸‚äººå£æ•°æ®ï¼ˆ1960-2016ï¼‰
        const populationData = [];
        const startYear = 1960;
        const endYear = 2016;
        const totalYears = endYear - startYear + 1;

        // Initial 1960 data - è°ƒæ•´åˆå§‹æ•°æ®ï¼Œè®©å›½å®¶ä¹‹é—´å·®å¼‚æ›´æ˜æ˜¾
        let currentYearData = [
            { name: "ä¸­å›½", population: 109420000, continent: "äºšæ´²", flag: "ğŸ‡¨ğŸ‡³" },
            { name: "å°åº¦", population: 78920000, continent: "äºšæ´²", flag: "ğŸ‡®ğŸ‡³" },
            { name: "ç¾å›½", population: 125268000, continent: "åŒ—ç¾æ´²", flag: "ğŸ‡ºğŸ‡¸" },
            { name: "æ—¥æœ¬", population: 59677000, continent: "äºšæ´²", flag: "ğŸ‡¯ğŸ‡µ" },
            { name: "å°å°¼", population: 14670000, continent: "äºšæ´²", flag: "ğŸ‡®ğŸ‡©" },
            { name: "å·´è¥¿", population: 31303000, continent: "å—ç¾æ´²", flag: "ğŸ‡§ğŸ‡·" },
            { name: "ä¿„ç½—æ–¯", population: 61940000, continent: "æ¬§æ´²", flag: "ğŸ‡·ğŸ‡º" },
            { name: "å¢¨è¥¿å“¥", population: 18469000, continent: "åŒ—ç¾æ´²", flag: "ğŸ‡²ğŸ‡½" },
            { name: "å¾·å›½", population: 53049000, continent: "æ¬§æ´²", flag: "ğŸ‡©ğŸ‡ª" },
            { name: "è‹±å›½", population: 43765000, continent: "æ¬§æ´²", flag: "ğŸ‡¬ğŸ‡§" },
            { name: "æ³•å›½", population: 34730000, continent: "æ¬§æ´²", flag: "ğŸ‡«ğŸ‡·" },
            { name: "æ„å¤§åˆ©", population: 30340000, continent: "æ¬§æ´²", flag: "ğŸ‡®ğŸ‡¹" },
            { name: "éŸ©å›½", population: 12550000, continent: "äºšæ´²", flag: "ğŸ‡°ğŸ‡·" },
            { name: "å—é", population: 10220000, continent: "éæ´²", flag: "ğŸ‡¿ğŸ‡¦" },
            { name: "æ¾³å¤§åˆ©äºš", population: 8630000, continent: "å¤§æ´‹æ´²", flag: "ğŸ‡¦ğŸ‡º" }
        ];
        
        // åˆå§‹æ’åº
        currentYearData.sort((a, b) => b.population - a.population);
        populationData.push({ year: startYear, countries: currentYearData });

        // Generate data for subsequent years (1961-2016)
        for (let i = 1; i < totalYears; i++) {
            const year = startYear + i;
            const previousYearData = populationData[i - 1].countries;

            const newCountries = previousYearData.map(country => {
                let growthRate = 0;

                // Different growth rates based on year and continent
                if (year < 1980) {
                    if (country.name === "ä¸­å›½") growthRate = 0.035 + Math.random() * 0.02;
                    else if (country.name === "å°åº¦") growthRate = 0.033 + Math.random() * 0.015;
                    else if (country.continent === "äºšæ´²") growthRate = 0.03 + Math.random() * 0.01;
                    else if (country.continent === "æ¬§æ´²") growthRate = 0.01 + Math.random() * 0.005;
                    else if (country.continent === "éæ´²") growthRate = 0.038 + Math.random() * 0.01;
                    else if (country.continent === "å¤§æ´‹æ´²") growthRate = 0.02 + Math.random() * 0.01;
                    else growthRate = 0.02 + Math.random() * 0.01;
                } else if (year < 2000) {
                    if (country.name === "ä¸­å›½") growthRate = 0.045 + Math.random() * 0.02;
                    else if (country.name === "å°åº¦") growthRate = 0.04 + Math.random() * 0.015;
                    else if (country.continent === "äºšæ´²") growthRate = 0.035 + Math.random() * 0.01;
                    else if (country.continent === "æ¬§æ´²") growthRate = 0.008 + Math.random() * 0.004;
                    else if (country.continent === "éæ´²") growthRate = 0.042 + Math.random() * 0.015;
                    else if (country.continent === "å¤§æ´‹æ´²") growthRate = 0.018 + Math.random() * 0.008;
                    else growthRate = 0.025 + Math.random() * 0.01;
                } else {
                    if (country.name === "ä¸­å›½") growthRate = 0.04 + Math.random() * 0.015;
                    else if (country.name === "å°åº¦") growthRate = 0.043 + Math.random() * 0.015;
                    else if (country.continent === "äºšæ´²") growthRate = 0.03 + Math.random() * 0.01;
                    else if (country.continent === "æ¬§æ´²") growthRate = 0.005 + Math.random() * 0.003;
                    else if (country.continent === "éæ´²") growthRate = 0.045 + Math.random() * 0.015;
                    else if (country.continent === "å¤§æ´‹æ´²") growthRate = 0.015 + Math.random() * 0.005;
                    else growthRate = 0.018 + Math.random() * 0.008;
                }

                // Apply growth rate (add some randomness)
                const newPopulation = Math.round(country.population * (1 + growthRate * (0.9 + Math.random() * 0.2))); // Add slight yearly variance

                return {
                    ...country,
                    population: newPopulation < 0 ? 0 : newPopulation // Ensure non-negative population
                };
            });

            // Sort by population for the *final* state of the year
            newCountries.sort((a, b) => b.population - a.population);

            populationData.push({
                year,
                countries: newCountries
            });
        }

        // Define continent gradient colors (light and dark mode)
        const continentGradients = {
            "äºšæ´²": "from-blue-500 to-blue-400",
            "æ¬§æ´²": "from-purple-500 to-purple-400",
            "åŒ—ç¾æ´²": "from-orange-500 to-orange-400",
            "å—ç¾æ´²": "from-yellow-500 to-yellow-400",
            "éæ´²": "from-green-500 to-green-400",
            "å¤§æ´‹æ´²": "from-pink-500 to-pink-400"
        };

        const continentGradientsDark = {
            "äºšæ´²": "from-blue-600 to-blue-500",
            "æ¬§æ´²": "from-purple-600 to-purple-500",
            "åŒ—ç¾æ´²": "from-orange-600 to-orange-500",
            "å—ç¾æ´²": "from-yellow-600 to-yellow-500",
            "éæ´²": "from-green-600 to-green-500",
            "å¤§æ´‹æ´²": "from-pink-600 to-pink-500"
        };

        // å¹³æ»‘æ­¥è¿›æ’å€¼å‡½æ•°
        function smoothStep(edge0, edge1, x) {
            x = Math.max(0, Math.min(1, (x - edge0) / (edge1 - edge0)));
            return x * x * (3 - 2 * x);
        }

        // çº¿æ€§æ’å€¼
        function lerp(a, b, t) {
            return a + (b - a) * t;
        }
        
        // å¹³æ»‘æ•°å­—åŠ¨ç”»
        function animateNumber(element, start, end, duration = 1000) {
            const startTime = performance.now();
            
            // æ·»åŠ æ•°å­—å˜åŒ–ç±»
            element.classList.add('changing');
            
            setTimeout(() => {
                element.classList.remove('changing');
                
                // åŠ¨ç”»å‡½æ•°
                function updateNumber(timestamp) {
                    const elapsed = timestamp - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const easedProgress = smoothStep(0, 1, progress);
                    
                    const current = Math.round(lerp(start, end, easedProgress));
                    element.textContent = formatLargePopulation(current);
                    
                    if (progress < 1) {
                        requestAnimationFrame(updateNumber);
                    }
                }
                
                requestAnimationFrame(updateNumber);
            }, 300); // ç­‰å¾…ç¦»å¼€åŠ¨ç”»å®Œæˆ
        }

        // Variables for animation state
        let animationFrameId = null;
        let isPlaying = false;
        let animationSpeed = 1; // Multiplier for animation duration
        let animationDurationPerYear = 1500; // Milliseconds per year transition
        let startTime = null; // Timestamp when the current year transition started
        let currentYearIndex = 0; // Index of the year *before* the current transition
        let selectedContinent = 'all'; // Default filter
        
        // ç”¨äºç¼“å­˜å‰ä¸€çŠ¶æ€çš„å˜é‡
        let previousTotalPopulation = 0;
        
        // å®šä¹‰æ›´å¤§æ›´ä¸€è‡´çš„æ¡å½¢é—´è·
        const BAR_HEIGHT = 56; // æ¯ä¸ªæ¡å½¢çš„é«˜åº¦ (px)
        const BAR_MARGIN = 16; // æ¡å½¢ä¹‹é—´çš„é—´è· (px)
        const TOTAL_BAR_HEIGHT = BAR_HEIGHT + BAR_MARGIN;

        // Store bar elements for efficient updates
        const barElements = new Map(); // Map<countryName, barElement>

        // DOM elements
        const barChart = document.getElementById('barChart');
        const yearSlider = document.getElementById('yearSlider');
        const currentYearDisplay = document.getElementById('currentYearDisplay');
        const totalPopulation = document.getElementById('totalPopulation');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const playIcon = document.getElementById('playIcon');
        const pauseIcon = document.getElementById('pauseIcon');
        const speedControl = document.getElementById('speedControl');
        const themeToggle = document.getElementById('themeToggle');
        const lightIcon = document.getElementById('lightIcon');
        const darkIcon = document.getElementById('darkIcon');
        const timeline = document.getElementById('timeline');
        const filterButtons = document.querySelectorAll('.filter-btn');

        // Pre-calculate max population and total populations for data analysis
        let maxPopulation = 0;
        let totalPopulationsByYear = [];
        let maxTotalPopulation = 0;

        populationData.forEach(yearData => {
            let total = 0;
            yearData.countries.forEach(country => {
                if (country.population > maxPopulation) {
                    maxPopulation = country.population;
                }
                total += country.population;
            });
            totalPopulationsByYear.push(total);
            if (total > maxTotalPopulation) {
                maxTotalPopulation = total;
            }
        });

        // Format population numbers professionally
        const numberFormatter = new Intl.NumberFormat('zh-CN', {
            notation: 'compact',
            compactDisplay: 'short',
            minimumFractionDigits: 0,
            maximumFractionDigits: 2
        });

        // Format large population numbers with units (e.g., 1.23äº¿)
        function formatLargePopulation(population) {
            if (population >= 100000000) {
                return (population / 100000000).toFixed(2) + 'äº¿';
            } else if (population >= 10000) {
                return (population / 10000).toFixed(2) + 'ä¸‡';
            }
            return numberFormatter.format(population);
        }

        // Interpolate data between two years
        function getInterpolatedData(yearIndexA, yearIndexB, progress) {
            const dataA = populationData[yearIndexA];
            const dataB = populationData[yearIndexB];

            // Create maps for quick lookup
            const countriesA = new Map(dataA.countries.map(c => [c.name, c]));
            const countriesB = new Map(dataB.countries.map(c => [c.name, c]));

            // Get all unique country names from both years
            const allCountryNames = new Set([...countriesA.keys(), ...countriesB.keys()]);

            const interpolatedCountries = [];
            let interpolatedTotalPop = 0;

            allCountryNames.forEach(name => {
                const countryA = countriesA.get(name);
                const countryB = countriesB.get(name);

                const popA = countryA ? countryA.population : 0;
                const popB = countryB ? countryB.population : 0;

                const interpolatedPop = lerp(popA, popB, progress);

                // Find the country data (prefer dataB for metadata like flag, continent)
                const countryData = countryB || countryA;

                if (countryData) { // Should always be true based on how allCountryNames is built
                    interpolatedCountries.push({
                        name: name,
                        population: interpolatedPop,
                        continent: countryData.continent,
                        flag: countryData.flag
                    });
                    interpolatedTotalPop += interpolatedPop;
                }
            });

            // Sort by interpolated population for the current frame
            interpolatedCountries.sort((a, b) => b.population - a.population);

            return {
                year: lerp(dataA.year, dataB.year, progress),
                countries: interpolatedCountries,
                totalPopulation: interpolatedTotalPop
            };
        }

        // å®Œå…¨æ¸…é™¤å›¾è¡¨å†…å®¹
        function clearChart() {
            // ç§»é™¤æ‰€æœ‰æ¡å½¢å…ƒç´ 
            barElements.forEach(element => {
                if (element.parentElement === barChart) {
                    barChart.removeChild(element);
                }
            });
            // æ¸…ç©ºå­˜å‚¨çš„å¼•ç”¨
            barElements.clear();
            
            // ç§»é™¤ä»»ä½•å…¶ä»–æ¶ˆæ¯å…ƒç´ 
            const noDataMsg = barChart.querySelector('.no-data-msg');
            if (noDataMsg) {
                barChart.removeChild(noDataMsg);
            }
        }

        // Update the chart display based on interpolated data
        function updateChartDisplay(interpolatedData) {
            const { year, countries, totalPopulation: currentTotalPop } = interpolatedData;

            // Apply continent filter
            const filteredCountries = selectedContinent === 'all'
                ? countries
                : countries.filter(country => country.continent === selectedContinent);

            // è®¡ç®—å›¾è¡¨é«˜åº¦ - ç¡®ä¿æœ‰è¶³å¤Ÿç©ºé—´æ˜¾ç¤ºæ‰€æœ‰æ¡å½¢
            const barCount = filteredCountries.length;
            const chartHeight = Math.max(600, barCount * TOTAL_BAR_HEIGHT + 40); // æ·»åŠ é¢å¤–ç©ºé—´
            barChart.style.minHeight = `${chartHeight}px`;

            // æ‰¾å‡ºä¸å†æ˜¾ç¤ºçš„æ¡å½¢
            const currentCountryNames = new Set(filteredCountries.map(c => c.name));
            const toRemove = [];
            
            barElements.forEach((element, countryName) => {
                if (!currentCountryNames.has(countryName)) {
                    // æ ‡è®°ä¸ºéœ€è¦ç§»é™¤
                    toRemove.push(countryName);
                    // å¼€å§‹æ·¡å‡ºåŠ¨ç”»
                    element.style.opacity = '0';
                    element.style.transform = `translateY(${element.offsetTop + 30}px)`;
                }
            });
            
            // åœ¨åŠ¨ç”»å®Œæˆåä»DOMç§»é™¤å…ƒç´ 
            setTimeout(() => {
                toRemove.forEach(name => {
                    const element = barElements.get(name);
                    if (element && element.parentElement === barChart) {
                        barChart.removeChild(element);
                        barElements.delete(name);
                    }
                });
            }, 700);

            // æ·»åŠ æˆ–æ›´æ–°æ¡å½¢
            filteredCountries.forEach((country, index) => {
                let barRow = barElements.get(country.name);

                if (!barRow) {
                    // åˆ›å»ºæ–°æ¡å½¢å…ƒç´ 
                    barRow = document.createElement('div');
                    barRow.className = 'bar-item opacity-0';
                    barRow.style.transform = `translateY(${chartHeight}px)`;
                    barRow.style.height = `${BAR_HEIGHT}px`; // ç¡®ä¿æ˜ç¡®çš„é«˜åº¦

                    const isLightMode = !document.documentElement.classList.contains('dark');
                    const gradientClass = isLightMode
                        ? `bg-gradient-to-r ${continentGradients[country.continent]}`
                        : `bg-gradient-to-r ${continentGradientsDark[country.continent]}`;

                    barRow.innerHTML = `
                        <div class="flex items-center w-[120px] min-w-[120px] pr-4">
                            <span class="mr-2 text-xl">${country.flag || ''}</span>
                            <span class="truncate font-medium text-gray-800 dark:text-gray-200 country-name">${country.name}</span>
                        </div>
                        <div class="relative flex-grow h-10">
                            <div class="absolute h-full ${gradientClass} rounded-r-md bar" style="width: 0%;">
                            </div>
                            <div class="value-label text-sm font-medium text-gray-700 dark:text-gray-300">
                                0
                            </div>
                        </div>
                    `;
                    barChart.appendChild(barRow);
                    barElements.set(country.name, barRow);

                    // å¼ºåˆ¶é‡æ–°å¸ƒå±€ï¼Œç¡®ä¿åˆå§‹çŠ¶æ€æ­£ç¡®
                    void barRow.offsetHeight;

                    // ä½¿ç”¨å»¶è¿Ÿæ˜¾ç¤ºæ¡å½¢
                    setTimeout(() => {
                        barRow.style.opacity = '1';
                        barRow.style.transform = `translateY(${index * TOTAL_BAR_HEIGHT}px)`;
                    }, index * 20);
                }

                // æ›´æ–°æ¡å½¢å®½åº¦å’Œæ ‡ç­¾å†…å®¹
                const barInner = barRow.querySelector('.bar');
                const valueLabel = barRow.querySelector('.value-label');
                const percentage = (country.population / maxPopulation) * 100;

                // è®¾ç½®è¿‡æ¸¡æ—¶é—´ CSS å˜é‡
                const currentWidth = parseFloat(barInner.style.width) || 0;
                const widthChange = Math.abs(percentage - currentWidth);
                const transitionDuration = 0.4 + (widthChange / 100) * 0.6;
                barRow.style.setProperty('--bar-transition-duration', `${transitionDuration}s`);

                // æ›´æ–°æ¡å½¢å®½åº¦
                barInner.style.width = `${percentage}%`;
                valueLabel.textContent = formatLargePopulation(Math.round(country.population));

                // æ™ºèƒ½æ ‡ç­¾å®šä½
                if (percentage > 30) { // è¾ƒé•¿æ¡å½¢
                    valueLabel.style.left = `calc(${percentage * 0.85}% - 5px)`;
                    valueLabel.style.color = 'white';
                    valueLabel.style.textShadow = '0 0 2px rgba(0,0,0,0.5)';
                } else if (percentage > 10) { // ä¸­ç­‰é•¿åº¦æ¡å½¢
                    valueLabel.style.left = `calc(${percentage}% + 8px)`;
                    valueLabel.style.color = '';
                    valueLabel.style.textShadow = '';
                } else { // è¾ƒçŸ­æ¡å½¢
                    valueLabel.style.left = `calc(${percentage}% + 12px)`;
                    valueLabel.style.color = '';
                    valueLabel.style.textShadow = '';
                }

                // æ›´æ–°æ¡å½¢å‚ç›´ä½ç½® - ä½¿ç”¨æ˜ç¡®çš„è®¡ç®—
                barRow.style.transform = `translateY(${index * TOTAL_BAR_HEIGHT}px)`;

                // æ›´æ–°æ¡å½¢æ¸å˜è‰²ä»¥åŒ¹é…å½“å‰ä¸»é¢˜
                const isLightMode = !document.documentElement.classList.contains('dark');
                const baseClasses = barInner.className.split(' ')
                    .filter(c => !c.startsWith('from-') && !c.startsWith('to-')).join(' ');
                const newGradientClass = isLightMode
                    ? `bg-gradient-to-r ${continentGradients[country.continent]}`
                    : `bg-gradient-to-r ${continentGradientsDark[country.continent]}`;
                barInner.className = `${baseClasses} ${newGradientClass}`;
            });

            // å¤„ç†æ— æ•°æ®æƒ…å†µ
            if (filteredCountries.length === 0) {
                if (!barChart.querySelector('.no-data-msg')) {
                    const noDataMsg = document.createElement('div');
                    noDataMsg.className = 'text-center py-10 text-gray-600 dark:text-gray-400 no-data-msg';
                    noDataMsg.textContent = 'æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ•°æ®';
                    barChart.appendChild(noDataMsg);
                }
            } else {
                const noDataMsg = barChart.querySelector('.no-data-msg');
                if (noDataMsg) {
                    barChart.removeChild(noDataMsg);
                }
            }

            // å¹³æ»‘æ›´æ–°æ€»äººå£æ•°å­—
            if (Math.abs(currentTotalPop - previousTotalPopulation) > 1000000) {
                animateNumber(totalPopulation, previousTotalPopulation, Math.round(currentTotalPop), 800);
                previousTotalPopulation = Math.round(currentTotalPop);
            } else {
                totalPopulation.textContent = formatLargePopulation(Math.round(currentTotalPop));
                previousTotalPopulation = Math.round(currentTotalPop);
            }
            
            // å¹³æ»‘æ›´æ–°å¹´ä»½æ˜¾ç¤º
            const currentYearInt = Math.round(year);
            const prevYearText = currentYearDisplay.textContent;
            if (prevYearText !== currentYearInt.toString()) {
                currentYearDisplay.classList.add('changing');
                setTimeout(() => {
                    currentYearDisplay.textContent = currentYearInt;
                    currentYearDisplay.classList.remove('changing');
                }, 300);
            }

            // æ›´æ–°æ—¶é—´è½´æŒ‡ç¤ºå™¨ä½ç½®
            const overallProgress = (year - startYear) / (endYear - startYear);
            updateTimelineIndicator(overallProgress);
        }
        
        // è·Ÿè¸ªå‰ä¸€å¹´ä»½
        let previousYearIndex = startYear;

        // Main animation loop
        function animate(timestamp) {
            if (!startTime) startTime = timestamp;

            const elapsed = timestamp - startTime;
            const durationPerYear = animationDurationPerYear / animationSpeed;
            const yearProgress = elapsed / durationPerYear; // Progress within the current year transition (0 to 1)

            let currentOverallYear = currentYearIndex + yearProgress;

            // Handle year completion
            if (yearProgress >= 1 && currentYearIndex < totalYears - 1) {
                startTime = timestamp; // Reset start time for the next transition
                currentYearIndex++; // Move to the next year index
                currentOverallYear = currentYearIndex; // Ensure year is exact at the transition point
            }

            // Clamp progress and year index
            const clampedYearProgress = Math.min(1, yearProgress);
            const clampedYearIndex = Math.min(totalYears - 1, currentYearIndex);

            // Apply enhanced easing to the progress within the year transition
            const easedProgress = smoothStep(0, 1, clampedYearProgress);

            // Determine the two years to interpolate between
            const yearIndexA = clampedYearIndex;
            const yearIndexB = Math.min(totalYears - 1, clampedYearIndex + 1); // Next year or current year if at the end

            // If we are at the very last year, just show the final state
            const finalProgress = (yearIndexA === totalYears - 1) ? 1 : easedProgress;

            // Get interpolated data
            const interpolatedData = getInterpolatedData(yearIndexA, yearIndexB, finalProgress);

            // Update chart display with interpolated data
            updateChartDisplay(interpolatedData);

            // Update slider position based on overall year progress
            yearSlider.value = currentOverallYear;

            // Continue animation if playing and not at the last year
            if (isPlaying && currentYearIndex < totalYears - 1) {
                animationFrameId = requestAnimationFrame(animate);
            } else if (currentYearIndex >= totalYears - 1) {
                // Reached the end, ensure final state is shown and pause
                updateChartDisplay(getInterpolatedData(totalYears - 1, totalYears - 1, 1)); // Ensure final year data is fully applied
                yearSlider.value = totalYears - 1;
                updateTimelineIndicator(1);
                pauseAnimation();
            }
        }

        // Play animation with enhanced effects
        function playAnimation() {
            if (!isPlaying) {
                isPlaying = true;
                
                // æ’­æ”¾æŒ‰é’®åŠ¨ç”»æ•ˆæœ
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
                
                // æ·»åŠ æŒ‰é’®æŒ‰ä¸‹æ•ˆæœ
                playPauseBtn.classList.add('scale-95');
                setTimeout(() => playPauseBtn.classList.remove('scale-95'), 200);

                // å¦‚æœå½“å‰åœ¨æœ€åä¸€å¹´ï¼Œéœ€è¦é‡ç½®åˆ°ç¬¬ä¸€å¹´
                if (currentYearIndex >= totalYears - 1) {
                    currentYearIndex = 0;
                    // æ¸…é™¤å¹¶é‡æ–°ç»˜åˆ¶å›¾è¡¨ï¼Œç¡®ä¿æ­£ç¡®çš„åˆå§‹çŠ¶æ€
                    clearChart();
                    updateChartDisplay(getInterpolatedData(0, 0, 0));
                }
                
                // é‡ç½®å¼€å§‹æ—¶é—´ï¼Œç¡®ä¿ä»å½“å‰çŠ¶æ€å¹³æ»‘è¿‡æ¸¡
                startTime = null;
                animationFrameId = requestAnimationFrame(animate);
            }
        }

        // Pause animation with enhanced effects
        function pauseAnimation() {
            isPlaying = false;
            
            // æš‚åœæŒ‰é’®åŠ¨ç”»æ•ˆæœ
            playIcon.classList.remove('hidden');
            pauseIcon.classList.add('hidden');
            
            // æ·»åŠ æŒ‰é’®æŒ‰ä¸‹æ•ˆæœ
            playPauseBtn.classList.add('scale-95');
            setTimeout(() => playPauseBtn.classList.remove('scale-95'), 200);

            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            
            // ç¡®ä¿æ˜¾ç¤ºç²¾ç¡®çš„å½“å‰å¹´ä»½æ•°æ®
            updateChartDisplay(getInterpolatedData(currentYearIndex, currentYearIndex, 0));
        }

        // Seek animation to a specific year index with enhanced effects
        function seekToYear(yearIndex) {
            // å­˜å‚¨å‰ä¸€ä¸ªå€¼ä»¥ç”¨äºåŠ¨ç”»
            const prevYearIndex = currentYearIndex;
            
            // é¦–å…ˆæš‚åœåŠ¨ç”»
            pauseAnimation();

            // æ›´æ–°å½“å‰å¹´ä»½ç´¢å¼•
            currentYearIndex = Math.max(0, Math.min(totalYears - 1, Math.floor(yearIndex)));

            // å¦‚æœæ˜¯è·³è·ƒå¼å˜åŒ–ï¼Œæ·»åŠ å¾®åŠ¨æ•ˆæœ
            if (Math.abs(prevYearIndex - currentYearIndex) > 5) {
                clearChart(); // æ¸…é™¤å¹¶é‡å»ºå›¾è¡¨ï¼Œé¿å…é‡å 
                barChart.classList.add('scale-98');
                setTimeout(() => barChart.classList.remove('scale-98'), 300);
            }

            // ç«‹å³æ›´æ–°æ˜¾ç¤ºä¸ºç›®æ ‡å¹´ä»½çš„çŠ¶æ€
            updateChartDisplay(getInterpolatedData(currentYearIndex, currentYearIndex, 0));

            // æ›´æ–°æ»‘å—ä½ç½®
            yearSlider.value = currentYearIndex;

            // æ›´æ–°æ—¶é—´è½´æŒ‡ç¤ºå™¨ä½ç½®
            updateTimelineIndicator(currentYearIndex / (totalYears - 1));
        }

        // Set continent filter with enhanced effects
        function setContinentFilter(continent) {
            // è®°å½•ä¹‹å‰çš„è¿‡æ»¤å™¨
            const prevContinent = selectedContinent;
            selectedContinent = continent;

            // Update filter button styles with enhanced feedback
            filterButtons.forEach(button => {
                button.classList.remove('active');
                if (button.getAttribute('data-continent') === continent) {
                    button.classList.add('active');
                    // æ·»åŠ ç‚¹å‡»æ•ˆæœ
                    button.classList.add('scale-110');
                    setTimeout(() => button.classList.remove('scale-110'), 300);
                }
            });

            // Pause animation and update the chart for the current year with the new filter
            pauseAnimation();
            
            // æ·»åŠ å¾®åŠ¨ç”»æ•ˆæœï¼Œä»…å½“åˆ‡æ¢ä¸åŒè¿‡æ»¤å™¨æ—¶
            if (prevContinent !== continent) {
                barChart.style.opacity = '0.8';
                barChart.style.transform = 'scale(0.98)';
                
                setTimeout(() => {
                    barChart.style.opacity = '1';
                    barChart.style.transform = 'scale(1)';
                    
                    // å®Œå…¨æ¸…é™¤å›¾è¡¨å¹¶é‡ç»˜
                    clearChart();
                    updateChartDisplay(getInterpolatedData(currentYearIndex, currentYearIndex, 0));
                }, 200);
            } else {
                // ç«‹å³æ›´æ–°ï¼Œæ— åŠ¨ç”»
                clearChart();
                updateChartDisplay(getInterpolatedData(currentYearIndex, currentYearIndex, 0));
            }
        }

        // Initialize timeline with enhanced visualization
        function initTimeline() {
            timeline.innerHTML = '';
            const baseDiv = document.createElement('div');
            baseDiv.className = 'absolute bottom-0 w-full h-1 bg-gray-300 dark:bg-zinc-700';
            timeline.appendChild(baseDiv);

            // Add year markers (e.g., every 10 years)
            const yearsToShow = [1960, 1970, 1980, 1990, 2000, 2010, 2016];
            yearsToShow.forEach(year => {
                const yearIndex = year - startYear;
                if (yearIndex >= 0 && yearIndex < totalYears) {
                    const position = (yearIndex / (totalYears - 1)) * 100;

                    const marker = document.createElement('div');
                    marker.className = 'absolute w-1 h-4 bg-gray-500 dark:bg-gray-400 rounded-full -mt-1.5 transition-all duration-300';
                    marker.style.left = `${position}%`;

                    const yearLabel = document.createElement('div');
                    yearLabel.className = 'absolute -mt-8 text-xs text-gray-600 dark:text-gray-400 transition-all duration-300';
                    yearLabel.style.left = `${position}%`;
                    yearLabel.style.transform = 'translateX(-50%)';
                    yearLabel.textContent = year.toString();

                    timeline.appendChild(marker);
                    timeline.appendChild(yearLabel);
                }
            });

            // Add click points for major years with enhanced interaction
            const clickYears = [1960, 1970, 1980, 1990, 2000, 2010, 2016];
            clickYears.forEach(year => {
                const yearIndex = year - startYear;
                if (yearIndex >= 0 && yearIndex < totalYears) {
                    const position = (yearIndex / (totalYears - 1)) * 100;
                    const clickPoint = document.createElement('div');
                    clickPoint.className = 'absolute w-4 h-4 bg-blue-500 rounded-full cursor-pointer -mt-1.5 -ml-2 hover:scale-150 transition-transform z-20 shadow-md';
                    clickPoint.style.left = `${position}%`;
                    clickPoint.setAttribute('data-year-index', yearIndex);
                    clickPoint.title = year.toString();

                    // Enhanced click interaction
                    clickPoint.addEventListener('click', function() {
                        const index = parseInt(this.getAttribute('data-year-index'));
                        // Visual feedback on click
                        this.classList.add('scale-75', 'bg-blue-600');
                        setTimeout(() => {
                            this.classList.remove('scale-75', 'bg-blue-600');
                        }, 300);
                        seekToYear(index);
                    });
                    
                    // Hover effect for subtle visual feedback
                    clickPoint.addEventListener('mouseenter', function() {
                        const yearLabel = document.createElement('div');
                        yearLabel.className = 'absolute -mt-8 bg-blue-100 dark:bg-blue-900 px-2 py-1 rounded text-xs text-blue-800 dark:text-blue-200 font-medium tooltip-year z-30';
                        yearLabel.style.left = '50%';
                        yearLabel.style.transform = 'translateX(-50%)';
                        yearLabel.textContent = year.toString();
                        this.appendChild(yearLabel);
                    });
                    
                    clickPoint.addEventListener('mouseleave', function() {
                        const tooltip = this.querySelector('.tooltip-year');
                        if (tooltip) this.removeChild(tooltip);
                    });
                    
                    timeline.appendChild(clickPoint);
                }
            });

            // Add current year indicator with breathing animation
            const currentIndicator = document.createElement('div');
            currentIndicator.id = 'currentIndicator';
            currentIndicator.className = 'absolute w-5 h-5 bg-red-500 rounded-full -mt-2 -ml-2.5 z-30 shadow-lg';
            currentIndicator.style.left = '0%'; // Initial position
            timeline.appendChild(currentIndicator);
        }

        // Update timeline indicator position with enhanced transitions
        function updateTimelineIndicator(overallProgress) {
            const position = overallProgress * 100;
            const indicator = document.getElementById('currentIndicator');
            if (indicator) {
                // Use smooth transition for indicator movement
                indicator.style.left = `${position}%`;
            }
        }

        // Event listeners with enhanced interactions
        playPauseBtn.addEventListener('click', function() {
            if (isPlaying) {
                pauseAnimation();
            } else {
                playAnimation();
            }
        });

        yearSlider.addEventListener('input', function() {
            // When user drags the slider, jump to that year immediately and pause
            const yearIndex = parseInt(this.value);
            seekToYear(yearIndex);
        });

        speedControl.addEventListener('change', function() {
            animationSpeed = parseFloat(this.value);
            // Visual feedback for speed change
            speedControl.classList.add('ring-2', 'ring-blue-500');
            setTimeout(() => speedControl.classList.remove('ring-2', 'ring-blue-500'), 300);
            
            // If playing, restart animation loop with new speed
            if (isPlaying) {
                pauseAnimation(); // Pause to cancel current frame
                playAnimation(); // Play to start new loop with updated speed
            }
        });

        themeToggle.addEventListener('click', function() {
            // Enhanced theme transition
            document.body.style.transition = 'background-color 0.5s ease, color 0.5s ease';
            document.documentElement.classList.toggle('dark');
            lightIcon.classList.toggle('hidden');
            darkIcon.classList.toggle('hidden');
            
            // Add visual feedback
            themeToggle.classList.add('rotate-180');
            setTimeout(() => themeToggle.classList.remove('rotate-180'), 500);
            
            // Redraw chart to apply new theme colors to gradients
            updateChartDisplay(getInterpolatedData(currentYearIndex, currentYearIndex, 0));
        });

        // Enhanced continent filter button interactions
        filterButtons.forEach(button => {
            button.addEventListener('click', function() {
                const continent = this.getAttribute('data-continent');
                setContinentFilter(continent);
            });
            
            // Add hover effect
            button.addEventListener('mouseenter', function() {
                if (!this.classList.contains('active')) {
                    this.classList.add('scale-105');
                }
            });
            
            button.addEventListener('mouseleave', function() {
                this.classList.remove('scale-105');
            });
        });

        // Check system dark mode preference on load
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
            lightIcon.classList.add('hidden');
            darkIcon.classList.remove('hidden');
        }

        // Add keyboard shortcuts with enhanced feedback
        document.addEventListener('keydown', function(e) {
            if (e.code === 'Space') { // Space key play/pause
                e.preventDefault();
                if (isPlaying) {
                    pauseAnimation();
                } else {
                    playAnimation();
                }
                
                // Visual feedback
                playPauseBtn.classList.add('ring-2', 'ring-blue-500');
                setTimeout(() => playPauseBtn.classList.remove('ring-2', 'ring-blue-500'), 300);
            } else if (e.code === 'ArrowRight') { // Right arrow forward one year
                e.preventDefault();
                if (currentYearIndex < totalYears - 1) {
                    seekToYear(currentYearIndex + 1);
                    yearSlider.classList.add('ring-2', 'ring-blue-500');
                    setTimeout(() => yearSlider.classList.remove('ring-2', 'ring-blue-500'), 300);
                }
            } else if (e.code === 'ArrowLeft') { // Left arrow back one year
                e.preventDefault();
                if (currentYearIndex > 0) {
                    seekToYear(currentYearIndex - 1);
                    yearSlider.classList.add('ring-2', 'ring-blue-500');
                    setTimeout(() => yearSlider.classList.remove('ring-2', 'ring-blue-500'), 300);
                }
            }
        });

        // Handle window resize for responsive visualizations
        window.addEventListener('resize', function() {
            // å®Œå…¨é‡æ–°ç»˜åˆ¶å›¾è¡¨ä»¥é€‚åº”æ–°çª—å£å°ºå¯¸
            clearChart();
            updateChartDisplay(getInterpolatedData(currentYearIndex, currentYearIndex, 0));
        });

        // Initial setup with enhanced animations
        yearSlider.max = totalYears - 1; // Set slider max based on total years
        
        // Add initial page load animations
        document.body.classList.add('opacity-0');
        
        setTimeout(() => {
            document.body.classList.remove('opacity-0');
            document.body.classList.add('transition-opacity', 'duration-500', 'opacity-100');
            
            initTimeline();
            seekToYear(0); // Initialize chart to the first year and pause
        }, 100);
    </script>


</body></html>